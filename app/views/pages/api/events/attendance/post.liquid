---
slug: api/v1/events/:id/attendance
method: post
layout: ''
response_headers: >
  {% render 'shared/api/headers' %}
---

{% liquid
  assign userid = null

  graphql result_usersByEmail = 'users/get_users', email: context.params.email
  log result_usersByEmail, type: 'debug'
  if result_usersByEmail.users.results.size > 0
    log "Found the user", type: 'debug'
    assign userid = result_usersByEmail.users.results[0].id
    log userid, type: 'debug'
  else
    log "Didn't find the user", type: 'debug'
  endif

  if userid == null
    log "Need to create the user", type: 'debug'
    assign terms_consent = false
    if context.params.terms_consent | titleize == "True"
      assign terms_consent = true
    endif
    graphql result_createUser = 'users/create_user', email: context.params.user_email, name: context.params.user_name, password: context.params.user_pass, company: context.params.company, cp_terms_consent: terms_consent
    log result_createUser, type: 'debug'
    assign userid = result_createUser.user_create.id
  endif

  assign userHandlingSuccess = false
  if userid != null
    assign userHandlingSuccess = true
  endif
  assign messages = "" | split: ','

  if userHandlingSuccess == false
    assign message = "There is a problem creating your user record, please try again later"
    assign messages = messages | add_to_array: message
  else
    graphql result_create = 'events/attendance/create_event_attendance', event_id: context.params.id, attendant_id: userid
    log result_create, type: 'debug'
    
    assign createEventAttendanceSuccess = false
    if result_create.event_attendance != null
      assign createEventAttendanceSuccess = true
    endif
  
    if createEventAttendanceSuccess == false
      assign message = "There is a problem creating your event attendance record, please try again later"
      assign messages = messages | add_to_array: message
    endif
  endif

  assign overallSuccess = false
  if userHandlingSuccess and createEventAttendanceSuccess
    assign overallSuccess = true
  endif

  if result_create == null
    assign result_create = '{}' | parse_json
  endif

  assign result_create = result_create | add_hash_key: "success", true
  
  unless overallSuccess
    response_status 200
    assign result_create = result_create | add_hash_key: "success", false
    assign result_create = result_create | add_hash_key: "messages", messages
  endunless
%}

{{- result_create }}